# IoT Sensor Data Publishing with MQTT on Raspberry Pi

We are installing and configuring the Mosquitto MQTT broker on a Raspberry Pi, and publish sensor data from a DHT11 (temperature/humidity) and an analog sound sensor using Python.

---

## Hardware Prerequisites

- Raspberry Pi
- DHT11 Temperature & Humidity Sensor (connected to GPIO17)
- Analog Sound Sensor via MCP3008 (CH0 input)
- Working MCP3008 wiring and SPI enabled

---

## Step 1: Install MQTT (Mosquitto)

```
sudo apt update
sudo apt install mosquitto mosquitto-clients -y
sudo systemctl enable mosquitto
```

---

## Step 2: Test MQTT Broker Locally

Open two terminal windows:

**Terminal 1: Subscribe**
```
mosquitto_sub -t test/topic
```

**Terminal 2: Publish**
```
mosquitto_pub -t test/topic -m "Hello MQTT"
```

---

## Step 3: Publish DHT11 Data to MQTT

### Install Required Libraries

```
pip3 install adafruit-circuitpython-dht paho-mqtt
sudo apt install libgpiod2 -y
```

### Python Script: `dht11_mqtt.py`

```
import time
import board
import adafruit_dht
import paho.mqtt.publish as publish

sensor = adafruit_dht.DHT11(board.D17)
MQTT_BROKER = "localhost"

while True:
    try:
        temperature = sensor.temperature
        humidity = sensor.humidity
        if temperature and humidity:
            print(f"Temp: {temperature}°C, Humidity: {humidity}%")
            publish.single("sensors/temp", str(temperature), hostname=MQTT_BROKER)
            publish.single("sensors/humidity", str(humidity), hostname=MQTT_BROKER)
    except RuntimeError:
        pass
    time.sleep(2)
```

Run it:
```bash
python3 dht11_mqtt.py
```

---

## Step 4: Publish Sound Sensor Data via MCP3008

### Install SPI Library

```
sudo apt install python3-spidev -y
```

### Python Script: `sound_mqtt.py`

```
import spidev
import time
import paho.mqtt.publish as publish

spi = spidev.SpiDev()
spi.open(0, 0)
spi.max_speed_hz = 1350000
MQTT_BROKER = "localhost"

def read_channel(channel):
    adc = spi.xfer2([1, (8 + channel) << 4, 0])
    data = ((adc[1] & 3) << 8) + adc[2]
    return data

print("Publishing sound data...")
try:
    while True:
        sound = read_channel(0)
        print("Sound Level (0–1023):", sound)
        publish.single("sensors/sound", str(sound), hostname=MQTT_BROKER)
        time.sleep(0.2)
except KeyboardInterrupt:
    print("Stopped.")
```

Run it:
```
python3 sound_mqtt.py
```
![iot_mqtt](/aawan/images/iot_sound_mqtt.png)
---

## Step 5: Launch Both Publishers with a Script

### Bash Script: `iot_mqtt_start.sh`

```
#!/bin/bash

# Start both in background and save their PIDs
python3 dht11_mqtt.py &
PID1=$!

python3 sound_mqtt.py &
PID2=$!

# Trap Ctrl+C (SIGINT)
trap "echo 'Stopping...'; kill $PID1 $PID2; exit" SIGINT

# Keep script alive
wait

```
![iot_mqtt](/aawan/images/iot_temphumidity_mqtt.png)


Make it executable:
```
chmod +x iot_mqtt_start.sh
./iot_mqtt_start.sh

```

---

## Subscribing to MQTT from differet device.
We installed MQTT on windows pc. Then with this command we can view the MQTT message. 
```
mosquitoo_sub -h <ip-address> -t sensors/sound
```
![win subscribe](/aawan/images/mqtt_win_cmd.png)


